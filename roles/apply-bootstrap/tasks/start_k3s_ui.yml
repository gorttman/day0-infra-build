---
- name: Expose ArgoCD server via NodePort
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    namespace: argocd
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: argocd-server
        labels:
          app.kubernetes.io/name: argocd-server
      spec:
        type: NodePort
        selector:
          app.kubernetes.io/name: argocd-server
        ports:
          - name: http
            port: 80
            targetPort: 8080
            nodePort: 30080
          - name: https
            port: 443
            targetPort: 8080
            nodePort: "{{ argocd_https_port }}"
  become: true

- name: Expose Kubernetes Dashboard service
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}" 
    state: present
    namespace: kubernetes-dashboard
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: kubernetes-dashboard
      spec:
        type: NodePort
        selector:
          k8s-app: kubernetes-dashboard
        ports:
          - port: 443
            targetPort: 8443
            nodePort: "{{ dash_https_port }}"

- name: Create Dashboard admin user
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}" 
    state: present
    namespace: kubernetes-dashboard
    definition:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: admin-user
        namespace: kubernetes-dashboard

- name: Bind cluster-admin to Dashboard admin user
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}" 
    state: present
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: dashboard-admin-user
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: cluster-admin
      subjects:
        - kind: ServiceAccount
          name: admin-user
          namespace: kubernetes-dashboard

- name: Wait for admin-user ServiceAccount
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig }}" 
    api_version: v1
    kind: ServiceAccount
    name: admin-user
    namespace: kubernetes-dashboard
  register: admin_sa
  until: admin_sa.resources | length > 0
  retries: 20
  delay: 5
  become: true

- name: Get Kubernetes Dashboard token
  ansible.builtin.command: >
    kubectl -n kubernetes-dashboard create token admin-user
  register: dashboard_token
  changed_when: false


- name: Relax permissions on kubeconfig so Ansible can read it
  file:
    path: /etc/rancher/k3s/k3s.yaml
    owner: root
    group: root
    mode: '0744'
  become: true
  become_user: root

