# FILE: roles/prep-rootfs/tasks/ensure_directories.yml
---
# Ensure all staging directories for rootfs creation exist.

- name: Safety check â€“ staging_rootfs must be defined and safe
  ansible.builtin.assert:
    that:
      - staging_rootfs is defined
      - staging_rootfs | length > 1
      - staging_rootfs != '/'
      - staging_rootfs is match('^/srv/build(/|$)')
    fail_msg: >
      REFUSING to run: invalid staging_rootfs ({{ staging_rootfs | default('UNSET') }}).
      Load variables/play/day1-prep-netboot.yml or set staging_rootfs explicitly.

- name: Ensure base staging directory exists
  ansible.builtin.file:
    path: "{{ staging_dir }}"
    state: directory
    mode: "0755"

- name: Ensure rootfs staging directory exists
  ansible.builtin.file:
    path: "{{ staging_rootfs }}"
    state: directory
    mode: "0755"

- name: Ensure necessary subdirectories inside rootfs staging path
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ staging_rootfs }}/etc"
    - "{{ staging_rootfs }}/boot"
    - "{{ staging_rootfs }}/var"
    - "{{ staging_rootfs }}/usr"
    - "{{ staging_rootfs }}/tmp"
